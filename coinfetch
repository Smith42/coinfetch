#!/usr/bin/env python3

# Delwink Software
# coinfetch
#
# This script is free software, released under the terms of the MIT license.
# See LICENSE for more information.
#
# This release of coinfetch is maintained by Delwink Software.
#
# Feature requests: sales@delwink.com
# Links to PGP keys available at http://delwink.com/contact.html
#
# Donate to Delwink!
# BTC  - 1HLpZxHSMbaq2pCeYRtYMsSYMFtsuSDknX
# LTC  - LYzCqLD5nrf1hnRe5uKpeThDDXd3B3TawC
# DOGE - DSiVFYZmMCykf5ALqBNwiah8h1zKqT4sZo

##### ORIGINAL DEVELOPER COMMENTS #####

# Created and maintained by Michael Smith (2014)
# And licensed under the MIT license 
# 
# Feel free to modify
# So generous: DGSWzqyofHC6YDSA34hwVQpWGQHnzJm1sk
#
# Values retrieved are in the form 
#       1 <coin_a> = <printed output> <coin_b>
#
# Remember to make this file executable ( "$chmod +x ./coinfetch" )

##### END ORIGINAL DEVELOPER COMMENTS #####

import requests, sys

def coinfetch(coin_a, coin_b, amt):
    """
    Fetch a coin pair
    """
    url = 'http://data.bter.com/api/1/tickers'
    r = requests.get(url)
    out = 0.0
    try:
        pair = coin_a+"_"+coin_b
        out = float(r.json()[pair]['avg']) * amt
    except KeyError:
        try:
            pair = coin_b+"_"+coin_a
            out = float((r.json()[pair]['avg']))**-1 * amt
        except KeyError:
            pair = coin_a+"_btc"
            out = float(r.json()[pair]['avg'])
            pair = "btc_"+coin_b
            try:
                out *= float(r.json()[pair]['avg'])
            except KeyError:
                pair = coin_b+"_btc"
                out *= float(r.json()[pair]['avg'])**-1
            out *= amt
    if out == 0.0:
        pair = coin_a+"_btc"
        out = float(r.json()[pair]['avg'])
        pair = "btc_"+coin_b
        try:
            out *= float(r.json()[pair]['avg'])
        except KeyError:
            pair = coin_b+"_btc"
            out *= float(r.json()[pair]['avg'])**-1
        out *= amt
    return out

try:
    argc = len(sys.argv)
    if argc == 4:
        amt = float(sys.argv[1])
        print ("%.8f" %coinfetch(sys.argv[2], sys.argv[3], amt))
    else:
        print ("%.8f" %coinfetch(sys.argv[1], sys.argv[2], 1.0))
#except UnboundLocalError:
#    print ("Currency pair was not found.")
#    exit(4)
except ValueError:
    print ('"' + sys.argv[1] + "\" is not a valid number.")
    exit(3)
except KeyError:
    print ("Currency pair was not found.")
    exit(2)
except IndexError:
    print ("USAGE: " + sys.argv[0] + " [amount] <from> <to>")
    exit(1)
